<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SBA Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#fff3ff" />

    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/buttons.css" />
    <link rel="stylesheet" href="css/cards.css" />
    <link rel="stylesheet" href="css/overlays.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<main class="app-shell">

    <header class="app-header">
        <div class="header-top">
            <h1 class="header-title">Species ID</h1>
            <div class="header-actions">
                <button class="ai-btn">Identify by Photo (AI)</button>
                <button class="settings-btn" id="openSettings">
                    <img src="Assets/ui/settings.svg" alt="Settings">
                </button>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-bar">
        <img src="Assets/ui/search.svg" class="search-icon-svg" alt="Search">
        <input type="text" placeholder="Search" id="searchInput">
    </div>         
        </div>
    </header>

    <div class="filter-section">
        <div class="filter-chips">
            <button class="filter-pill active" data-filter="all">All</button>
            <button class="filter-pill" data-filter="leaf-type">
                Leaf Type <span class="chevron"></span>
            </button>
            <button class="filter-pill" data-filter="fruit-type">
                Fruit Type <span class="chevron"></span>
            </button>
            <button class="filter-pill" data-filter="a-z">
                Name <span class="chevron"></span>
            </button>
        </div>
    </div>

    <div class="container" id="species-list"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="scripts/specieslist.js"></script>
    <script src="scripts/filterCarousel.js"></script>

    <a class="back-link" href="index.html"></a>
    <div class="debug" id="debugInfo"></div>

    <div class="lang-overlay" id="langOverlay">
        <div class="lang-modal">
            <button class="close-overlay" id="closeOverlay">✖</button>
            <button class="lang-choice" id="chooseEn">English</button>
            <button class="lang-choice" id="chooseTet">Tetum</button>
        </div>
    </div>

    <div class="filter-overlay" id="filterOverlay">
        <div class="filter-modal">
            <button class="close-filter-overlay" id="closeFilterOverlay">✖</button>
            <h2 id="filterTitle"></h2>
            <p id="filterDescription"></p>
            <div id="filterOptions"></div>
        </div>
    </div>

</main>

<script>
// --- LANGUAGE HANDLER ---
let lang = "en";
try {
    const stored = localStorage.getItem("appLanguage");
    if (stored === "en" || stored === "tet") lang = stored;
} catch (e) { console.warn(e); }

const overlay = document.getElementById("langOverlay");
const closeBtn = document.getElementById("closeOverlay");
const settingsBtn = document.getElementById("openSettings"); // Use settings icon to trigger

settingsBtn.addEventListener("click", () => overlay.style.display = "flex");
closeBtn.addEventListener("click", () => overlay.style.display = "none");

document.getElementById("chooseEn").onclick = () => {
    localStorage.setItem("appLanguage", "en");
    location.reload(); 
};
document.getElementById("chooseTet").onclick = () => {
    localStorage.setItem("appLanguage", "tet");
    location.reload();
};

// --- FILTER OVERLAY LOGIC ---
const filterOverlay = document.getElementById("filterOverlay");
const closeFilterOverlay = document.getElementById("closeFilterOverlay");
const filterTitle = document.getElementById("filterTitle");
const filterOptions = document.getElementById("filterOptions");
const filterDescription = document.getElementById("filterDescription");

const filterConfigs = {
    "a-z": {
        title: "Sort Alphabetically",
        description: "Sort species in ascending or descending order.",
        options: [
            { label: "A → Z", action: () => sortSpecies("az") },
            { label: "Z → A", action: () => sortSpecies("za") }
        ]
    },
    "leaf-type": {
        title: "Leaf Type",
        description: "Filter species by their leaf types.",
        options: [
            { label: "Compound", action: () => console.log("Compound filter") },
            { label: "Simple", action: () => console.log("Simple filter") }
        ]
    },
    "fruit-type": {
        title: "Fruit Type",
        description: "Filter species by their fruit types.",
        options: [
            { label: "Fleshy", action: () => console.log("Fleshy filter") },
            { label: "Dry", action: () => console.log("Dry filter") }
        ]
    }
};

// Handle Pill Clicks
document.querySelectorAll(".filter-pill").forEach(btn => {
    btn.addEventListener("click", () => {
        const key = btn.dataset.filter;

        // Toggle active UI
        document.querySelectorAll(".filter-pill").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (key === "all") {
            if(typeof renderSpecies === "function" && typeof loadedSpeciesData !== "undefined"){
                renderSpecies(loadedSpeciesData);
            }
            filterOverlay.style.display = "none";
            return;
        }

        const config = filterConfigs[key];
        if(!config) return;

        filterTitle.textContent = config.title;
        filterDescription.textContent = config.description;
        filterOptions.innerHTML = "";

        config.options.forEach(option => {
            const optionBtn = document.createElement("button");
            optionBtn.className = "placeholder-option";
            optionBtn.textContent = option.label;
            optionBtn.onclick = () => {
                if (option.action) option.action();
                filterOverlay.style.display = "none";
            };
            filterOptions.appendChild(optionBtn);
        });

        filterOverlay.style.display = "flex";
    });
});

closeFilterOverlay.addEventListener("click", () => filterOverlay.style.display = "none");

// --- SORTING LOGIC ---
function sortSpecies(direction) {
    if (typeof loadedSpeciesData === "undefined" || loadedSpeciesData.length === 0) return;

    const sorted = [...loadedSpeciesData].sort((a, b) => {
        const nameA = a.scientific_name.toLowerCase();
        const nameB = b.scientific_name.toLowerCase();
        return direction === "az" ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    });

    renderSpecies(sorted);
}
</script>

</body>
</html>